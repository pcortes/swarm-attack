# v0.3.0 Bug Fix Plan

**Date:** 2025-12-29
**Investigators:** Expert Subagents (CLI, Documentation, Audit)
**Commit:** f73a50c

---

## Summary of Issues

| Bug ID | Severity | Category | Files Affected |
|--------|----------|----------|----------------|
| BUG-001 | Medium | CLI | 2 files |
| BUG-002 | High | Documentation | 3 files |
| BUG-003 | Low | Documentation | 1 file |

---

## BUG-001: CLI --auto/--manual Flags Missing

### Root Cause
The auto-approval infrastructure is fully implemented but the CLI `approve` commands don't expose `--auto`/`--manual` flags to users.

### Existing Infrastructure (No Changes Needed)
- `swarm_attack/auto_approval/spec.py` - SpecAutoApprover
- `swarm_attack/auto_approval/issue.py` - IssueAutoGreenlighter
- `swarm_attack/auto_approval/bug.py` - BugAutoApprover
- `swarm_attack/state_store.py:847-888` - `set_manual_mode()`, `is_manual_mode()`
- `swarm_attack/cli/approval.py` - Standalone `approval auto/manual` commands

### Fix Plan

#### Change 1: `swarm_attack/cli/feature.py` (lines 921-927)

**BEFORE:**
```python
@app.command()
def approve(
    feature_id: str = typer.Argument(
        ...,
        help="Feature ID to approve the spec for.",
    ),
) -> None:
```

**AFTER:**
```python
@app.command()
def approve(
    feature_id: str = typer.Argument(
        ...,
        help="Feature ID to approve the spec for.",
    ),
    auto: bool = typer.Option(
        False,
        "--auto",
        help="Enable auto-approval mode for this feature.",
    ),
    manual: bool = typer.Option(
        False,
        "--manual",
        help="Disable auto-approval (require manual approvals).",
    ),
) -> None:
```

**Add after line 937 (before existing logic):**
```python
    # Handle mode flags
    if auto and manual:
        console.print("[red]Error:[/red] Cannot use both --auto and --manual simultaneously.")
        raise typer.Exit(1)

    if auto:
        store.set_manual_mode(feature_id, False)
        console.print(f"[green]Auto-approval mode enabled for {feature_id}[/green]")
    elif manual:
        store.set_manual_mode(feature_id, True)
        console.print(f"[yellow]Manual approval mode enabled for {feature_id}[/yellow]")
```

#### Change 2: `swarm_attack/cli/bug.py` (lines 412-423)

**BEFORE:**
```python
@app.command("approve")
def bug_approve(
    bug_id: str = typer.Argument(
        ...,
        help="Bug ID to approve for implementation.",
    ),
    yes: bool = typer.Option(
        False,
        "--yes", "-y",
        help="Skip confirmation prompt.",
    ),
) -> None:
```

**AFTER:**
```python
@app.command("approve")
def bug_approve(
    bug_id: str = typer.Argument(
        ...,
        help="Bug ID to approve for implementation.",
    ),
    yes: bool = typer.Option(
        False,
        "--yes", "-y",
        help="Skip confirmation prompt.",
    ),
    auto: bool = typer.Option(
        False,
        "--auto",
        help="Enable auto-approval mode for bug fixes.",
    ),
    manual: bool = typer.Option(
        False,
        "--manual",
        help="Disable auto-approval (require manual review).",
    ),
) -> None:
```

**Add similar mode-handling logic after line 440.**

### Verification
```bash
swarm-attack approve test-feature --auto
swarm-attack approve test-feature --manual
swarm-attack bug approve bug-123 --auto
swarm-attack bug approve bug-123 --manual
# Should error:
swarm-attack approve test-feature --auto --manual
```

---

## BUG-002: Documentation Uses Wrong Event Type Names

### Root Cause
Documentation references `EventType.IMPL_COMPLETED` and `EventType.ISSUE_GREENLIGHTED` which don't exist in the actual enum.

### Mapping: Wrong â†’ Correct

| Documented (Wrong) | Actual (Correct) |
|-------------------|------------------|
| `IMPL_COMPLETED` | `IMPL_VERIFIED` |
| `ISSUE_GREENLIGHTED` | `ISSUE_READY` |

### Fix Plan

#### Change 1: `CLAUDE.md` (lines 496-522)

**Line 500:**
```diff
- EventType.ISSUE_GREENLIGHTED # Issue ready for implementation
+ EventType.ISSUE_READY        # Issue ready for implementation
```

**Line 502:**
```diff
- EventType.IMPL_COMPLETED     # Coder finished successfully
+ EventType.IMPL_VERIFIED      # Coder finished successfully
```

**Line 522:**
```diff
- bus.subscribe(EventType.IMPL_COMPLETED, on_impl_complete)
+ bus.subscribe(EventType.IMPL_VERIFIED, on_impl_complete)
```

#### Change 2: `.claude/prompts/expert-tester.md` (lines 210-217)

```diff
  received = []
- bus.subscribe(EventType.IMPL_COMPLETED, lambda e: received.append(e))
+ bus.subscribe(EventType.ISSUE_COMPLETE, lambda e: received.append(e))
  bus.emit(SwarmEvent(
-     event_type=EventType.IMPL_COMPLETED,
+     event_type=EventType.ISSUE_COMPLETE,
      feature_id="test",
      issue_number=1,
      source_agent="test",
  ))
```

#### Change 3: `docs/USER_GUIDE.md` (lines 884-888)

```diff
- bus.subscribe(EventType.IMPL_COMPLETED, handler)
+ bus.subscribe(EventType.IMPL_VERIFIED, handler)

  bus.emit(SwarmEvent(
-     event_type=EventType.IMPL_COMPLETED,
+     event_type=EventType.IMPL_VERIFIED,
      feature_id="test-feature",
```

### Verification
```python
python3 -c "
from swarm_attack.events.types import EventType
assert hasattr(EventType, 'IMPL_VERIFIED')
assert hasattr(EventType, 'ISSUE_READY')
assert not hasattr(EventType, 'IMPL_COMPLETED')
assert not hasattr(EventType, 'ISSUE_GREENLIGHTED')
print('Event type names verified')
"
```

---

## BUG-003: Documentation Numeric Discrepancies

### Root Cause
CLAUDE.md contains outdated counts and values for agent profiles and event types.

### Fix Plan

#### Change 1: Event Count (Line 496)

```diff
- # Available event types (27 total):
+ # Available event types (28 total):
```

#### Change 2: Agent Context Profiles Table (Lines 578-585)

**BEFORE:**
```markdown
| Agent | Token Budget | Depth | Includes |
|-------|--------------|-------|----------|
| **Coder** | 15,000 | full_source | Project instructions, module registry, completed summaries, test structure |
| **Verifier** | 3,000 | compact | Module registry, test paths |
| **SpecAuthor** | 8,000 | summary | PRD, existing patterns |
| **IssueCreator** | 5,000 | summary | Spec, sizing guidelines |
```

**AFTER:**
```markdown
| Agent | Token Budget | Depth | Includes |
|-------|--------------|-------|----------|
| **Coder** | 15,000 | full_source | Project instructions, module registry, completed summaries, dependencies, related tests |
| **SpecAuthor** | 5,000 | summary | Project instructions, architecture overview, existing modules, conventions |
| **SpecCritic** | 3,000 | summary | Project instructions, review guidelines, past feedback |
| **SpecModerator** | 3,000 | summary | Project instructions, review guidelines |
| **IssueCreator** | 4,000 | compact | Project instructions, existing issues, module registry |
| **BugResearcher** | 10,000 | full_source | Project instructions, test structure, recent changes, failure history |
| **RootCauseAnalyzer** | 8,000 | full_source | Project instructions, test structure, module registry |
| **FixPlanner** | 5,000 | summary | Project instructions, module registry, completed summaries |
| **Verifier** | 3,000 | compact | Project instructions, test patterns, coverage gaps |
| **ComplexityGate** | 2,000 | compact | Project instructions |
```

### Verification
```python
python3 -c "
from swarm_attack.universal_context_builder import AGENT_CONTEXT_PROFILES
from swarm_attack.events.types import EventType

assert len(AGENT_CONTEXT_PROFILES) == 10, f'Expected 10 profiles, got {len(AGENT_CONTEXT_PROFILES)}'
assert len([e for e in EventType]) == 28, f'Expected 28 events, got {len([e for e in EventType])}'
assert AGENT_CONTEXT_PROFILES['spec_author']['max_tokens'] == 5000
assert AGENT_CONTEXT_PROFILES['issue_creator']['max_tokens'] == 4000
print('All discrepancies verified')
"
```

---

## Implementation Priority

| Priority | Bug ID | Effort | Impact |
|----------|--------|--------|--------|
| P1 | BUG-001 | Medium | Users can't enable auto-approval from CLI |
| P2 | BUG-002 | Low | Documentation causes immediate errors |
| P3 | BUG-003 | Low | Documentation inaccuracy |

---

## Files to Modify

| File | Changes |
|------|---------|
| `swarm_attack/cli/feature.py` | Add --auto/--manual flags to approve command |
| `swarm_attack/cli/bug.py` | Add --auto/--manual flags to bug_approve command |
| `CLAUDE.md` | Fix event types, counts, and profiles table |
| `.claude/prompts/expert-tester.md` | Fix event type in test example |
| `docs/USER_GUIDE.md` | Fix event type in documentation |

---

## Test Commands After Fixes

```bash
# Unit tests
PYTHONPATH=. pytest tests/unit/test_auto_approval.py -v

# CLI integration
swarm-attack approve test-feature --help  # Should show --auto/--manual
swarm-attack bug approve bug-123 --help   # Should show --auto/--manual

# Event type validation
python3 -c "from swarm_attack.events.types import EventType; print([e.name for e in EventType])"
```
